<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbraix AI - Minimalist Assistant</title>
    <link rel="icon" href="img/logo_round.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="icons/css/all.css" />
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/github.css">
</head>
<body>
    <div id="splash-screen">
        <img src="img/logo_transparant.png" alt="Umbraix AI Loading">
    </div>

    <!-- API Key Setup Modal -->
    <div class="api-setup" id="apiSetup">
        <div class="api-setup-content">
            <div class="api-popup-header">
                <h3>API Key Management</h3>
                <button class="close-popup" id="closeApiSetup"><i class="fas fa-times"></i></button>
            </div>
            <div class="api-tabs">
                <button class="api-tab-button active" data-tab="gemini">Gemini</button>
                <button class="api-tab-button" data-tab="openrouter">OpenRouter</button>
                <button class="api-tab-button" data-tab="googlesearch">Google Search</button>
            </div>
            <div id="gemini-settings" class="api-tab-content active">
                <h4>Google Gemini API</h4>
                <p>High-quality models from Google.</p>
                <div class="api-key-input-container">
                    <input type="password" id="geminiApiKeyInput" placeholder="Enter your Gemini API key">
                    <button class="toggle-api-visibility" data-input="geminiApiKeyInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-setup-actions">
                    <button id="saveGeminiApiKey">Save Key</button>
                    <button id="removeGeminiApiKey" class="remove-button">Remove Key</button>
                </div>
                <p class="api-link">Get a key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
            </div>
            <div id="openrouter-settings" class="api-tab-content">
                <h4>OpenRouter API</h4>
                <p>Access a wide variety of models.</p>
                <div class="api-key-input-container">
                    <input type="password" id="openRouterApiKeyInput" placeholder="Enter your OpenRouter API key">
                    <button class="toggle-api-visibility" data-input="openRouterApiKeyInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-setup-actions">
                    <button id="saveOpenRouterApiKey">Save Key</button>
                    <button id="removeOpenRouterApiKey" class="remove-button">Remove Key</button>
                </div>
                <p class="api-link">Get a key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a></p>
            </div>
            <div id="googlesearch-settings" class="api-tab-content">
                <h4>Google Custom Search API</h4>
                <p>For web search functionality. CSE ID is also required.</p>
                <div class="api-key-toggle-container">
                    <label class="switch">
                        <input type="checkbox" id="useCustomGoogleKeys">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label">Use Custom Google Keys</span>
                </div>
                <div class="api-key-input-container">
                    <input type="password" id="googleApiKeyInput" placeholder="Enter your Google Search API key" disabled>
                    <button class="toggle-api-visibility" data-input="googleApiKeyInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-key-input-container">
                    <input type="password" id="googleCseIdInput" placeholder="Enter your Google CSE ID" disabled>
                    <button class="toggle-api-visibility" data-input="googleCseIdInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-setup-actions">
                    <button id="saveGoogleSearchKeys">Save Keys</button>
                    <button id="removeGoogleSearchKeys" class="remove-button">Remove Keys</button>
                </div>
                <p class="api-link">Get keys from <a href="https://developers.google.com/custom-search/v1/overview" target="_blank">Google Cloud Console</a></p>
                <div id="quota-info" style="margin-top: 10px; font-size: 0.8rem; color: var(--gray);"></div>
            </div>
            <p class="api-storage-notice"><small>Your API keys are stored locally and never shared.</small></p>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-left">
                <img src="img/logo_transparant.png" alt="Umbraix AI">
                <div class="chat-title">
                    <h2>Umbraix AI</h2>
                    <p>Powered by <span id="modelName">Gemini 2.5 Flash</span></p>
                </div>
            </div>
            <div class="chat-header-right">
                <button class="header-action-button" id="modelSelectButton">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h3>Welcome to Umbraix AI</h3>
                <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
            </div>
            <div class="thinking-indicator" id="thinkingIndicator">Thinking...</div>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div class="popup-menu" id="popupMenu">
            <div class="popup-header">
                <h3>Select Mode</h3>
                <button class="close-popup" id="closePopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="normal">
                    <i class="fas fa-comment"></i>
                    <div class="option-text">
                        <h4>Normal</h4>
                        <p>Standard conversation</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="webSearch">
                    <i class="fas fa-search"></i>
                    <div class="option-text">
                        <h4>Web Search</h4>
                        <p>Search and analyze information</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="think">
                    <i class="fas fa-lightbulb"></i>
                    <div class="option-text">
                        <h4>Think Mode</h4>
                        <p>Deep analytical thinking</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="creative">
                    <i class="fas fa-paint-brush"></i>
                    <div class="option-text">
                        <h4>Creative</h4>
                        <p>Brainstorming & ideas</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="imagen">
                    <i class="fas fa-image"></i>
                    <div class="option-text">
                        <h4>Imagen</h4>
                        <p>Generate images from text</p>
                        <span class="paid-notice">Paid API key required</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-area">
                <button class="mode-button" id="modeButton">
                    <i class="fas fa-plus"></i>
                </button>
                <input type="text" class="chat-input" id="userInput" placeholder="Message Umbraix AI...">
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="stop-button" id="stopButton" style="display: none;">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>

        <div class="popup-menu" id="modelPopupMenu">
            <div class="popup-header">
                <h3>Select Model</h3>
                <button class="close-popup" id="closeModelPopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-bar-container">
                <i class="fas fa-search"></i>
                <input type="text" id="modelSearchInput" placeholder="Search models...">
            </div>
            <div class="popup-footer">
                <button class="manage-api-button" id="manageApiButton">Manage API Keys</button>
                <button class="refresh-models-button" id="refreshModelsButton">
                    <i class="fas fa-sync-alt"></i> Refresh Models
                </button>
            </div>
            <div class="model-options">
                <!-- Models will be dynamically populated here -->
            </div>
        </div>
    </div>

    <script src="search.js"></script>
    <script>
        // API Key Configuration
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let OPENROUTER_API_KEY = localStorage.getItem('openrouter_api_key') || '';
        let GOOGLE_API_KEY = localStorage.getItem('google_api_key') || 'AIzaSyBy6hIfvcKPvxsXw10ZQQ7NZPiQB-RgjuM';
        let GOOGLE_CSE_ID = localStorage.getItem('google_cse_id') || 'a55abf5c6e62745c5';
        let useCustomGoogleKeys = localStorage.getItem('use_custom_google_keys') === 'true';
        
        // Chat state
        let conversationHistory = [];
        let currentMode = 'normal';
        let currentModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
        let isGenerating = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const stopButton = document.getElementById('stopButton');
        const modeButton = document.getElementById('modeButton');
        const popupMenu = document.getElementById('popupMenu');
        const closePopup = document.getElementById('closePopup');
        const overlay = document.getElementById('overlay');
        const modeOptions = document.querySelectorAll('.mode-option');
        const modelSelectButton = document.getElementById('modelSelectButton');
        const modelPopupMenu = document.getElementById('modelPopupMenu');
        const closeModelPopup = document.getElementById('closeModelPopup');
        const modelOptions = document.querySelectorAll('.model-option');
        const apiSetup = document.getElementById('apiSetup');
        const manageApiButton = document.getElementById('manageApiButton');
        const closeApiSetup = document.getElementById('closeApiSetup');
        const apiTabs = document.querySelectorAll('.api-tab-button');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const openRouterApiKeyInput = document.getElementById('openRouterApiKeyInput');
        const saveGeminiApiKey = document.getElementById('saveGeminiApiKey');
        const removeGeminiApiKey = document.getElementById('removeGeminiApiKey');
        const saveOpenRouterApiKey = document.getElementById('saveOpenRouterApiKey');
        const removeOpenRouterApiKey = document.getElementById('removeOpenRouterApiKey');
        const toggleApiVisibilityButtons = document.querySelectorAll('.toggle-api-visibility');
        const refreshModelsButton = document.getElementById('refreshModelsButton');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const googleCseIdInput = document.getElementById('googleCseIdInput');
        const saveGoogleSearchKeys = document.getElementById('saveGoogleSearchKeys');
        const removeGoogleSearchKeys = document.getElementById('removeGoogleSearchKeys');
        const useCustomGoogleKeysToggle = document.getElementById('useCustomGoogleKeys');

        let allModels = [];
        const modelSearchInput = document.getElementById('modelSearchInput');

        // Mode system prompts
        const modePrompts = {
            normal: "You are Umbraix AI, a helpful and friendly assistant. Provide clear, concise, and accurate responses. Be conversational and engaging.",
            
            webSearch: "You are Umbraix AI in Web Search mode. Act as if you have access to current web information and provide comprehensive, well-researched responses with specific details and examples. Be thorough and informative.",
            
            think: "You are Umbraix AI in Think Mode. Provide deep, analytical responses. Break down complex topics, show your reasoning process, consider multiple perspectives, and provide thoughtful insights. Structure your responses with clear logic and evidence.",
            
            creative: "You are Umbraix AI in Creative mode. Be imaginative, innovative, and think outside the box. Provide creative solutions, generate novel ideas, use analogies, and approach problems from unique angles. Be inspiring and original.",

            imagen: "You are Umbraix AI in Imagen mode. Generate an image based on the user's prompt. You should only respond with the image, no text."
        };

        // Initialize markdown-it
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre class="hljs"><code>' +
                               hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                               '</code></pre>';
                    } catch (__) {}
                }

                return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        // Customize markdown-it renderer for fenced code blocks
        md.renderer.rules.fence = function (tokens, idx, options, env, self) {
            const token = tokens[idx];
            const info = token.info ? md.utils.unescapeAll(token.info).trim() : '';
            let langName = '', langAttrs = '';
            if (info) {
                const arr = info.split(/(\s+)/g);
                langName = arr[0];
                langAttrs = arr.slice(1).join('');
            }
            const code = token.content;
            const codeId = `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            const highlighted = options.highlight(code, langName, langAttrs) || md.utils.escapeHtml(code);

            return `
                <div class="code-block-container">
                    <div class="code-block-header">
                        <span class="language-name">${langName || 'plaintext'}</span>
                        <button class="copy-code-button" onclick="copyCode(this, '${codeId}')" title="Copy code">
                            <i class="far fa-clipboard"></i>
                            <span>Copy</span>
                        </button>
                    </div>
                    <div id="${codeId}" style="display:none;">${md.utils.escapeHtml(code)}</div>
                    ${highlighted}
                </div>
            `;
        };

        function copyCode(button, codeId) {
            if (!navigator.clipboard) {
                console.error('Clipboard API not available');
                button.innerHTML = '<span>Not supported</span>';
                button.disabled = true;
                return;
            }
            const codeElement = document.getElementById(codeId);
            if (codeElement) {
                navigator.clipboard.writeText(codeElement.innerText).then(() => {
                    button.innerHTML = '<i class="fas fa-check"></i> <span>Copied</span>';
                    button.classList.add('copied');
                    button.disabled = true;
                    setTimeout(() => {
                        button.innerHTML = '<i class="far fa-clipboard"></i> <span>Copy</span>';
                        button.classList.remove('copied');
                        button.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy code: ', err);
                    button.innerHTML = '<span>Failed!</span>';
                });
            }
        }

        function copyMessage(buttonEl) {
            const messageEl = buttonEl.closest('.ai-message');
            const contentEl = messageEl.querySelector('.message-content');
            if (contentEl) {
                navigator.clipboard.writeText(contentEl.innerText).then(() => {
                    const icon = buttonEl.querySelector('i');
                    const originalIcon = icon.className;
                    buttonEl.innerHTML = '<i class="fas fa-check"></i>';
                    buttonEl.title = "Copied!";
                    setTimeout(() => {
                        buttonEl.innerHTML = `<i class="${originalIcon}"></i>`;
                        buttonEl.title = "Copy message";
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy message: ', err);
                });
            }
        }

        function selectMessage(buttonEl) {
            const messageEl = buttonEl.closest('.ai-message');
            const contentEl = messageEl.querySelector('.message-content');
            if (contentEl && window.getSelection) {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(contentEl);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function createStreamingMessageElement() {
            const element = document.createElement('div');
            element.classList.add('message', 'ai-message');

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            element.appendChild(messageContent);

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('message-actions');
            actionsDiv.innerHTML = `
                <button onclick="copyMessage(this)" title="Copy message">
                    <i class="far fa-copy"></i>
                </button>
                <button onclick="selectMessage(this)" title="Select message">
                        <i class="fas fa-i-cursor"></i>
                </button>
                    <button onclick="regenerateResponse(this)" class="regenerate-button" title="Regenerate response">
                        <i class="fas fa-sync-alt"></i>
                    </button>
            `;
            element.appendChild(actionsDiv);

            chatMessages.appendChild(element);
            return element;
        }


        function loadGeneratedImages() {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('generated_image_')) {
                    const imageData = JSON.parse(localStorage.getItem(key));
                    addMessage(imageData.imageUrl, false, false, imageData.prompt);
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (!GEMINI_API_KEY && !OPENROUTER_API_KEY) {
                showApiSetup();
            } else {
                hideApiSetup();
                addInitialMessage();
                loadGeneratedImages();
            }
            
            updateSelection('mode', currentMode);
            updateChatHeader();
            setupEventListeners();
            populateModels();
        });

        // API Key Management
        function showApiSetup() {
            geminiApiKeyInput.value = GEMINI_API_KEY;
            openRouterApiKeyInput.value = OPENROUTER_API_KEY;

            useCustomGoogleKeysToggle.checked = useCustomGoogleKeys;
            toggleGoogleKeyInputs(useCustomGoogleKeys);

            if (useCustomGoogleKeys) {
                googleApiKeyInput.value = GOOGLE_API_KEY === 'AIzaSyBy6hIfvcKPvxsXw10ZQQ7NZPiQB-RgjuM' ? '' : GOOGLE_API_KEY;
                googleCseIdInput.value = GOOGLE_CSE_ID === 'a55abf5c6e62745c5' ? '' : GOOGLE_CSE_ID;
            }

            apiSetup.style.display = 'flex';
            updateQuotaInfo();
        }

        function toggleGoogleKeyInputs(enabled) {
            googleApiKeyInput.disabled = !enabled;
            googleCseIdInput.disabled = !enabled;
            if (!enabled) {
                googleApiKeyInput.value = '';
                googleCseIdInput.value = '';
                googleApiKeyInput.placeholder = 'Using default keys';
                googleCseIdInput.placeholder = 'Using default CSE ID';
            } else {
                googleApiKeyInput.placeholder = 'Enter your Google Search API key';
                googleCseIdInput.placeholder = 'Enter your Google CSE ID';
            }
        }

        function updateQuotaInfo() {
            const quotaInfo = document.getElementById('quota-info');
            if (!useCustomGoogleKeys) {
                const today = new Date().toISOString().split('T')[0];
                const quota = JSON.parse(localStorage.getItem('google_search_quota') || '{}');
                if (quota.date === today) {
                    quotaInfo.textContent = `Default key queries today: ${quota.count || 0} / 100`;
                } else {
                    quotaInfo.textContent = 'Default key queries today: 0 / 100';
                }
                quotaInfo.style.display = 'block';
            } else {
                quotaInfo.style.display = 'none';
            }
        }

        function hideApiSetup() {
            apiSetup.style.display = 'none';
        }

        function saveApiKey(keyType) {
            let key, input;
            if (keyType === 'gemini') {
                input = geminiApiKeyInput;
                key = input.value.trim();
                GEMINI_API_KEY = key;
                localStorage.setItem('gemini_api_key', key);
            } else if (keyType === 'openrouter'){
                input = openRouterApiKeyInput;
                key = input.value.trim();
                OPENROUTER_API_KEY = key;
                localStorage.setItem('openrouter_api_key', key);
            } else if (keyType === 'googlesearch') {
                if (useCustomGoogleKeys) {
                    const apiKey = googleApiKeyInput.value.trim();
                    const cseId = googleCseIdInput.value.trim();
                    GOOGLE_API_KEY = apiKey;
                    GOOGLE_CSE_ID = cseId;
                    localStorage.setItem('google_api_key', apiKey);
                    localStorage.setItem('google_cse_id', cseId);
                    alert('Google Search keys saved!');
                } else {
                    alert("Custom keys are not enabled. Please toggle the switch to save your keys.");
                }
                hideApiSetup();
                return;
            }
            alert(`${keyType.charAt(0).toUpperCase() + keyType.slice(1)} API Key saved!`);
            hideApiSetup();
            if (conversationHistory.length === 0) {
                addInitialMessage();
            }
            populateModels(); // Refresh models after adding a key
        }

        function removeApiKey(keyType) {
            if (confirm(`Are you sure you want to remove your ${keyType} API key?`)) {
                if (keyType === 'gemini') {
                    localStorage.removeItem('gemini_api_key');
                    GEMINI_API_KEY = '';
                    geminiApiKeyInput.value = '';
                } else if (keyType === 'openrouter') {
                    localStorage.removeItem('openrouter_api_key');
                    OPENROUTER_API_KEY = '';
                    openRouterApiKeyInput.value = '';
                } else if (keyType === 'googlesearch') {
                    localStorage.removeItem('google_api_key');
                    localStorage.removeItem('google_cse_id');
                    GOOGLE_API_KEY = 'AIzaSyBy6hIfvcKPvxsXw10ZQQ7NZPiQB-RgjuM';
                    GOOGLE_CSE_ID = 'a55abf5c6e62745c5';
                    googleApiKeyInput.value = '';
                    googleCseIdInput.value = '';
                    alert('Google Search keys removed.');
                    return;
                }
                alert(`${keyType.charAt(0).toUpperCase() + keyType.slice(1)} API Key removed.`);
            }
        }

        function formatAIResponse(text) {
            return md.render(text);
        }

        function addSearchResults(results) {
            const resultsId = `search-results-${Date.now()}`;
            const resultsDiv = document.createElement('div');
            resultsDiv.classList.add('message', 'ai-message', 'search-results-container');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p>No search results found.</p>';
            } else {
                const resultsList = results.map((item, index) => `
                    <div class="search-result-item">
                        <div class="search-result-title">
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                        </div>
                        <div class="search-result-url">${item.displayLink}</div>
                        <div class="search-result-snippet">${item.snippet}</div>
                    </div>
                `).join('');
                resultsDiv.innerHTML = `
                    <div class="search-results-header">
                        <h4>Web Search Results</h4>
                        <button class="collapse-button" data-target="${resultsId}">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="search-results-list" id="${resultsId}">
                        ${resultsList}
                    </div>
                `;

                const collapseButton = resultsDiv.querySelector('.collapse-button');
                const searchResultsList = resultsDiv.querySelector('.search-results-list');

                // Start collapsed
                searchResultsList.style.display = 'none';

                collapseButton.addEventListener('click', () => {
                    const isCollapsed = searchResultsList.style.display === 'none';
                    searchResultsList.style.display = isCollapsed ? 'block' : 'none';
                    const icon = collapseButton.querySelector('i');
                    icon.classList.toggle('fa-chevron-down', !isCollapsed);
                    icon.classList.toggle('fa-chevron-up', isCollapsed);
                });
            }
            chatMessages.appendChild(resultsDiv);
            scrollToBottom();
        }

        // Message Management
        function addMessage(text, isUser = false, isError = false, prompt = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (isUser) {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('ai-message');
                if (isError) {
                    messageDiv.classList.add('error-message');
                }

                if (prompt) {
                    const promptDiv = document.createElement('div');
                    promptDiv.classList.add('prompt-text');
                    promptDiv.textContent = prompt;
                    messageDiv.appendChild(promptDiv);
                }
                
                if (text.startsWith('data:image/')) {
                    const img = document.createElement('img');
                    img.src = text;
                    img.classList.add('generated-image');
                    messageDiv.appendChild(img);
                } else {
                    const messageContent = document.createElement('div');
                    messageContent.classList.add('message-content');
                    messageContent.innerHTML = formatAIResponse(text);
                    messageDiv.appendChild(messageContent);

                    if (!isError) {
                        const actionsDiv = document.createElement('div');
                        actionsDiv.classList.add('message-actions');
                        actionsDiv.innerHTML = `
                            <button onclick="copyMessage(this)" title="Copy message">
                                <i class="far fa-copy"></i>
                            </button>
                            <button onclick="selectMessage(this)" title="Select message">
                                <i class="fas fa-i-cursor"></i>
                            </button>
                            <button onclick="regenerateResponse(this)" class="regenerate-button" title="Regenerate response">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        `;
                        messageDiv.appendChild(actionsDiv);
                    }
                }
                
                // Add mode indicator if not normal and not error
                if (currentMode !== 'normal' && !isError) {
                    const modeIndicator = document.createElement('span');
                    modeIndicator.classList.add('mode-indicator');
                    modeIndicator.textContent = getDisplayName('mode', currentMode);
                    messageDiv.appendChild(modeIndicator);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addInitialMessage() {
            addMessage("Hello! I'm Umbraix AI, powered by Google Gemini 2.5 Flash. How can I help you today?");
        }

        function getDisplayName(type, value) {
            const names = {
                mode: {
                    normal: 'Normal',
                    webSearch: 'Web Search',
                    think: 'Think Mode',
                    creative: 'Creative',
                    imagen: 'Imagen'
                },
                model: {
                    'gemini-2.5-pro': 'Gemini 2.5 Pro',
                    'gemini-2.5-flash': 'Gemini 2.5 Flash',
                    'gemini-2.0-flash': 'Gemini 2.0 Flash',
                    'gemini-2.5-flash-image-preview': 'Gemini 2.5 Flash Image',
                    'imagen-4.0-generate-001': 'Imagen 4.0'
                }
            };
            return names[type][value] || value;
        }

        function updateChatHeader() {
            const modelNameSpan = document.getElementById('modelName');
            if (modelNameSpan) {
                modelNameSpan.textContent = getDisplayName('model', currentModel);
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Typing Indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typingIndicatorOld';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicatorOld');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function showThinkingIndicator() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.style.display = 'block';
            scrollToBottom();
        }

        function hideThinkingIndicator() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.style.display = 'none';
        }

        // Gemini AI Integration
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        async function populateModels() {
            const modelOptionsContainer = modelPopupMenu.querySelector('.model-options');
            modelOptionsContainer.innerHTML = '<div class="loading-models"><span><i class="fas fa-spinner fa-spin"></i> Loading models...</span></div>';

            const staticGeminiModels = [
                { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', description: 'Most powerful model', provider: 'gemini' },
                { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', description: 'Fast and efficient', provider: 'gemini' },
                { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', description: 'Legacy fast model', provider: 'gemini' },
                { id: 'gemini-2.5-flash-image-preview', name: 'Gemini 2.5 Flash Image', description: 'Conversational image generation', provider: 'gemini' },
                { id: 'imagen-4.0-generate-001', name: 'Imagen 4.0', description: 'Dedicated image generation', provider: 'gemini' }
            ];

            allModels = staticGeminiModels.map(m => ({...m, provider: 'gemini'}));

            if (OPENROUTER_API_KEY) {
                try {
                    const openRouterModels = await fetchOpenRouterModels(OPENROUTER_API_KEY);
                    const mappedModels = openRouterModels.map(model => ({
                        id: model.id,
                        name: model.name,
                        description: `Context: ${model.context_length.toLocaleString()} tokens`,
                        provider: 'openrouter'
                    }));
                    allModels = allModels.concat(mappedModels);
                } catch (error) {
                    console.error("Failed to fetch OpenRouter models:", error);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'model-option-error';
                    errorDiv.textContent = 'Failed to load OpenRouter models. Check your API key.';
                    modelOptionsContainer.appendChild(errorDiv);
                }
            }

            displayModels(allModels);

            // Set default or saved model
            currentModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
            updateSelection('model', currentModel);
            updateChatHeader();
        }

        function displayModels(modelsToDisplay) {
            const modelOptionsContainer = modelPopupMenu.querySelector('.model-options');
            modelOptionsContainer.innerHTML = ''; // Clear loading/previous models

            if (modelsToDisplay.length === 0) {
                modelOptionsContainer.innerHTML = '<div class="model-option-error">No models available. Please check your API keys.</div>';
                return;
            }

            modelsToDisplay.forEach(model => {
                const option = document.createElement('div');
                option.className = 'model-option';
                option.setAttribute('data-model', model.id);

                // Choose icon based on provider
                let iconClass = 'fa-robot'; // Default
                if (model.provider === 'gemini') {
                    iconClass = 'fa-gem'; // Using Font Awesome's gem icon
                } else if (model.provider === 'openrouter') {
                    iconClass = 'fa-route'; // Using Font Awesome's route icon
                }

                option.innerHTML = `
                    <i class="fas ${iconClass}"></i>
                    <div class="option-text">
                        <h4>${escapeHtml(model.name)}</h4>
                        <p>${escapeHtml(model.description)}</p>
                    </div>
                `;
                modelOptionsContainer.appendChild(option);

                option.addEventListener('click', function() {
                    const selectedModelId = this.getAttribute('data-model');
                    const selectedModelData = allModels.find(m => m.id === selectedModelId);

                    if (selectedModelData) {
                        currentModel = selectedModelData.id;
                        localStorage.setItem('gemini_model', currentModel);
                        updateSelection('model', currentModel);
                        updateChatHeader();
                        closeModelPopupMenu();
                    } else {
                        console.error("Could not find the selected model in the allModels array.");
                    }
                });
            });
        }

        async function callApi(message, onChunk, onComplete, history = null) {
            const modelData = allModels.find(m => m.id === currentModel);
            if (!modelData) {
                throw new Error("Selected model not found!");
            }

            const conversationContext = history || conversationHistory;

            if (modelData.provider === 'openrouter') {
                if (!OPENROUTER_API_KEY) throw new Error("OpenRouter API key not set.");
                const openRouterHistory = conversationContext.map(item => ({
                    role: item.role === 'model' ? 'assistant' : 'user',
                    content: item.parts[0].text
                }));
                await callOpenRouterAPI(OPENROUTER_API_KEY, currentModel, openRouterHistory, onChunk, onComplete, abortController.signal);
            } else {
                // Default to Gemini
                if (!GEMINI_API_KEY) throw new Error("Gemini API key not set.");
                await callGeminiAPI(message, onChunk, onComplete, conversationContext);
            }
        }

        async function callGeminiAPI(message, onChunk, onComplete, history) {
            const systemPrompt = modePrompts[currentMode];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:streamGenerateContent?key=${GEMINI_API_KEY}&alt=sse`;

            let conversationContext = [{ role: "user", parts: [{ text: systemPrompt }] }];
            conversationContext = conversationContext.concat(history.slice(-10));
            conversationContext.push({ role: "user", parts: [{ text: message }] });

            const requestBody = {
                contents: conversationContext,
                generationConfig: {
                    temperature: currentMode === 'creative' ? 0.9 : 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
                signal: abortController.signal
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = "";

            while (true) {
                if (abortController.signal.aborted) {
                    reader.cancel();
                    break;
                }
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.substring(6);
                        try {
                            const parsed = JSON.parse(jsonStr);
                            if (parsed.candidates && parsed.candidates[0] && parsed.candidates[0].content) {
                                const text = parsed.candidates[0].content.parts[0].text;
                                fullResponse += text;
                                onChunk(text);
                            }
                        } catch (e) {
                            // Ignore parsing errors, likely incomplete JSON
                        }
                    }
                }
            }
            onComplete(fullResponse);
        }

        async function callImagen4API(message) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${GEMINI_API_KEY}`;

            const requestBody = {
                "instances": [
                    {
                        "prompt": message
                    }
                ],
                "parameters": {
                    "sampleCount": 1
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.predictions && data.predictions[0] && data.predictions[0].image) {
                    const imageUrl = `data:image/png;base64,${data.predictions[0].image.bytesBase64Encoded}`;
                    const imageId = `generated_image_${Date.now()}`;
                    const imageData = {
                        prompt: message,
                        imageUrl: imageUrl
                    };
                    localStorage.setItem(imageId, JSON.stringify(imageData));
                    return imageUrl;
                }

                throw new Error('No image data found in response');

            } catch (error) {
                console.error('Imagen 4 API Error:', error);
                throw error;
            }
        }

        async function callGeminiFlashImageAPI(message) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;

            const requestBody = {
                contents: [{
                    parts: [
                        { "text": message }
                    ]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const imagePart = data.candidates[0].content.parts.find(part => part.inline_data);
                    if (imagePart) {
                        const imageUrl = `data:image/png;base64,${imagePart.inline_data.data}`;
                        const imageId = `generated_image_${Date.now()}`;
                        const imageData = {
                            prompt: message,
                            imageUrl: imageUrl
                        };
                        localStorage.setItem(imageId, JSON.stringify(imageData));
                        return imageUrl;
                    }
                }

                throw new Error('No image data found in response');

            } catch (error) {
                console.error('Imagen API Error:', error);
                throw error;
            }
        }

        // Message Sending
        let abortController = new AbortController();

        function stopGeneration() {
            abortController.abort();
            isGenerating = false;
            sendButton.style.display = 'block';
            stopButton.style.display = 'none';
            userInput.disabled = false;
            userInput.focus();
            hideTypingIndicator();
        }

        async function regenerateResponse(buttonEl) {
            if (isGenerating) return;

            const aiMessageToRemove = buttonEl.closest('.ai-message');
            const lastMessage = chatMessages.lastElementChild;

            // Ensure we are only regenerating the last message
            if (aiMessageToRemove !== lastMessage) {
                alert("You can only regenerate the last response.");
                return;
            }

            // Pop the last AI response from history
            if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'model') {
                conversationHistory.pop();
            } else {
                // Should not happen if the button is on an AI message
                return;
            }

            // Get the last user prompt
            let lastUserPrompt = null;
            if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                lastUserPrompt = conversationHistory[conversationHistory.length - 1].parts[0].text;
            }

            if (lastUserPrompt) {
                // Remove the AI message from the DOM
                aiMessageToRemove.remove();
                // Execute the prompt again
                await executePrompt(lastUserPrompt);
            }
        }

        async function executePrompt(prompt) {
            isGenerating = true;
            sendButton.style.display = 'none';
            stopButton.style.display = 'block';
            userInput.disabled = true;
            abortController = new AbortController();

            let currentResponse = "";
            let responseStarted = false;
            let aiMessageElement;

            const onChunk = (text) => {
                if (abortController.signal.aborted) return;
                if (!responseStarted) {
                    hideTypingIndicator();
                    responseStarted = true;
                }
                currentResponse += text;
                if (aiMessageElement) {
                    const contentEl = aiMessageElement.querySelector('.message-content');
                    if (contentEl) {
                        contentEl.innerHTML = formatAIResponse(currentResponse);
                    }
                }
                scrollToBottom();
            };

            const onComplete = (fullResponse) => {
                if (abortController.signal.aborted) {
                    conversationHistory.push({ role: "model", parts: [{ text: currentResponse + "..." }] });
                } else {
                    conversationHistory.push({ role: "model", parts: [{ text: fullResponse }] });
                }
                isGenerating = false;
                sendButton.style.display = 'block';
                stopButton.style.display = 'none';
                userInput.disabled = false;
                userInput.focus();
            };

            try {
                if (currentMode === 'webSearch') {
                    showThinkingIndicator();
                    try {
                        const searchResults = await callGoogleSearchApi(prompt);
                        hideThinkingIndicator();

                        if (searchResults.length > 0) {
                            addSearchResults(searchResults);
                            const searchContext = searchResults.map((item, index) => `[${index + 1}] Title: ${item.title}\nSnippet: ${item.snippet}`).join('\n\n');
                            const augmentedMessage = `User query: "${prompt}"\n\nPlease provide a comprehensive answer based on the following search results:\n\n${searchContext}`;
                            const tempHistory = [...conversationHistory];
                            tempHistory.push({ role: "user", parts: [{ text: augmentedMessage }] });

                            aiMessageElement = createStreamingMessageElement();
                            showTypingIndicator();
                            await callApi(augmentedMessage, onChunk, onComplete, tempHistory);
                        } else {
                            addMessage("No web search results found. Trying a normal response.", false, false);
                            aiMessageElement = createStreamingMessageElement();
                            showTypingIndicator();
                            await callApi(prompt, onChunk, onComplete);
                        }
                    } catch (error) {
                        hideThinkingIndicator();
                        addMessage(`Search failed: ${error.message}`, false, true);
                        onComplete("");
                    }
                } else if (currentMode === 'imagen') {
                    hideTypingIndicator();
                    let response;
                    if (currentModel === 'gemini-2.5-flash-image-preview') {
                        response = await callGeminiFlashImageAPI(prompt);
                    } else if (currentModel === 'imagen-4.0-generate-001') {
                        response = await callImagen4API(prompt);
                    } else {
                        response = await callGeminiFlashImageAPI(prompt);
                    }
                    addMessage(response, false, false, prompt);
                    onComplete(response);
                } else {
                    aiMessageElement = createStreamingMessageElement();
                    showTypingIndicator();
                    await callApi(prompt, onChunk, onComplete);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    hideTypingIndicator();
                    let errorMessage = 'Sorry, I encountered an error. ' + (error.message || 'Please try again.');
                    addMessage(errorMessage, false, true);
                }
                onComplete("");
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isGenerating) return;

            addMessage(message, true);
            userInput.value = '';
            sendButton.classList.remove('active');

            conversationHistory.push({ role: "user", parts: [{ text: message }] });

            await executePrompt(message);
        }

        // Mode and Model Management
        function updateSelection(type, value) {
            const options = type === 'mode' ? modeOptions : modelOptions;
            options.forEach(option => {
                const dataValue = option.getAttribute(`data-${type}`);
                option.classList.toggle('active', dataValue === value);
            });
        }

        function openPopup() {
            closeModelPopupMenu();
            popupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('mode', currentMode);
        }

        function closePopupMenu() {
            popupMenu.classList.remove('show');
            if (!modelPopupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        function openModelPopup() {
            closePopupMenu();
            modelPopupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('model', currentModel);
        }

        function closeModelPopupMenu() {
            modelPopupMenu.classList.remove('show');
            if (!popupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            modeButton.addEventListener('click', openPopup);
            closePopup.addEventListener('click', closePopupMenu);

            modelSelectButton.addEventListener('click', openModelPopup);
            closeModelPopup.addEventListener('click', closeModelPopupMenu);

            overlay.addEventListener('click', () => {
                closePopupMenu();
                closeModelPopupMenu();
            });
            
            modeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentMode = this.getAttribute('data-mode');
                    updateSelection('mode', currentMode);
                    closePopupMenu();
                });
            });

            modelOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentModel = this.getAttribute('data-model');
                    localStorage.setItem('gemini_model', currentModel);
                    updateSelection('model', currentModel);
                    updateChatHeader();
                    closeModelPopupMenu();
                });
            });

            manageApiButton.addEventListener('click', () => {
                closeModelPopupMenu();
                showApiSetup();
            });

            closeApiSetup.addEventListener('click', hideApiSetup);

            apiTabs.forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    document.querySelectorAll('.api-tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tab}-settings`).classList.add('active');
                    document.querySelectorAll('.api-tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });

            toggleApiVisibilityButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.dataset.input;
                    const input = document.getElementById(inputId);
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    button.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
                });
            });

            saveGeminiApiKey.addEventListener('click', () => saveApiKey('gemini'));
            removeGeminiApiKey.addEventListener('click', () => removeApiKey('gemini'));
            saveOpenRouterApiKey.addEventListener('click', () => saveApiKey('openrouter'));
            removeOpenRouterApiKey.addEventListener('click', () => removeApiKey('openrouter'));
            useCustomGoogleKeysToggle.addEventListener('change', () => {
                useCustomGoogleKeys = useCustomGoogleKeysToggle.checked;
                localStorage.setItem('use_custom_google_keys', useCustomGoogleKeys);
                toggleGoogleKeyInputs(useCustomGoogleKeys);
                updateQuotaInfo();
            });
            saveGoogleSearchKeys.addEventListener('click', () => saveApiKey('googlesearch'));
            removeGoogleSearchKeys.addEventListener('click', () => removeApiKey('googlesearch'));
            refreshModelsButton.addEventListener('click', populateModels);
            stopButton.addEventListener('click', stopGeneration);

            modelSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredModels = allModels.filter(model => model.name.toLowerCase().includes(searchTerm));
                displayModels(filteredModels);
            });

            // Close popups when clicking outside
            document.addEventListener('click', function(e) {
                if (popupMenu.classList.contains('show') && 
                    !popupMenu.contains(e.target) && 
                    !modeButton.contains(e.target)) {
                    closePopupMenu();
                }
                if (modelPopupMenu.classList.contains('show') &&
                    !modelPopupMenu.contains(e.target) &&
                    !modelSelectButton.contains(e.target)) {
                    closeModelPopupMenu();
                }
            });
            
            // Focus input when page loads
            userInput.focus();

            // API key input events
            geminiApiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveApiKey('gemini');
                }
            });
            openRouterApiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveApiKey('openrouter');
                }
            });

            // Send button active state
            userInput.addEventListener('input', () => {
                if (userInput.value.trim() !== '') {
                    sendButton.classList.add('active');
                } else {
                    sendButton.classList.remove('active');
                }
            });
        }

        // Clear conversation (optional feature)
        function clearConversation() {
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h3>Welcome to Umbraix AI</h3>
                    <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
                </div>
            `;
            addInitialMessage();
        }

        // Make clearConversation available globally for debugging
        window.clearConversation = clearConversation;

        // Splash screen logic
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');

            // Start the fade out
            setTimeout(() => {
                splash.classList.add('hidden');
            }, 2000);

            // Remove from DOM after transition
            splash.addEventListener('transitionend', (e) => {
                if (e.propertyName === 'opacity') {
                    splash.style.display = 'none';
                }
            });
        });
        
    </script>
</body>
</html>
