<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbraix AI - Minimalist Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- API Key Setup Modal -->
    <div class="api-setup" id="apiSetup">
        <div class="api-setup-content">
            <h3 id="apiSetupTitle">Setup Gemini AI</h3>
            <p id="apiSetupSubtitle">To use Umbraix AI, you need to provide your Google Gemini API key.</p>
            <div class="api-key-input-container">
                <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key">
                <button id="toggleApiVisibility" class="api-key-action-button"><i class="fas fa-eye"></i></button>
            </div>
            <div class="api-setup-actions">
                <button id="saveApiKeyButton">Save & Continue</button>
                <button id="copyApiKey">Copy Key</button>
                <button id="removeApiKeyButton" class="remove-button">Remove Key</button>
            </div>
            <p>Don't have an API key? <a href="https://aistudio.google.com/app/apikey" target="_blank">Get one here</a></p>
            <p><small>Your API key is stored locally and never shared.</small></p>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23222222'/><circle cx='35' cy='40' r='5' fill='white'/><circle cx='65' cy='40' r='5' fill='white'/><path d='M30 70 Q50 85 70 70' stroke='white' stroke-width='5' fill='none'/></svg>" alt="Umbraix AI">
            <div class="chat-header-info">
                <h2>Umbraix AI</h2>
                <p>Online • Powered by Gemini 2.5 Flash</p>
            </div>
            <button class="model-select-button" id="modelSelectButton">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h3>Welcome to Umbraix AI</h3>
                <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
            </div>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div class="popup-menu" id="popupMenu">
            <div class="popup-header">
                <h3>Select Mode</h3>
                <button class="close-popup" id="closePopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="normal">
                    <i class="fas fa-comment"></i>
                    <h4>Normal</h4>
                    <p>Standard conversation</p>
                </div>
                <div class="mode-option" data-mode="webSearch">
                    <i class="fas fa-search"></i>
                    <h4>Web Search</h4>
                    <p>Search and analyze information</p>
                </div>
                <div class="mode-option" data-mode="think">
                    <i class="fas fa-lightbulb"></i>
                    <h4>Think Mode</h4>
                    <p>Deep analytical thinking</p>
                </div>
                <div class="mode-option" data-mode="creative">
                    <i class="fas fa-paint-brush"></i>
                    <h4>Creative</h4>
                    <p>Brainstorming & ideas</p>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-area">
                <button class="mode-button" id="modeButton">
                    <i class="fas fa-plus"></i>
                </button>
                <input type="text" class="chat-input" id="userInput" placeholder="Message Umbraix AI...">
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <div class="popup-menu" id="modelPopupMenu">
            <div class="popup-header">
                <h3>Select Model</h3>
                <button class="close-popup" id="closeModelPopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="model-options">
                <div class="model-option" data-model="gemini-2.5-pro">
                    <i class="fas fa-brain"></i>
                    <h4>Gemini 2.5 Pro</h4>
                    <p>Most powerful model</p>
                </div>
                <div class="model-option active" data-model="gemini-2.5-flash">
                    <i class="fas fa-bolt"></i>
                    <h4>Gemini 2.5 Flash</h4>
                    <p>Fast and efficient</p>
                </div>
                <div class="model-option" data-model="gemini-2.0-flash">
                    <i class="fas fa-rocket"></i>
                    <h4>Gemini 2.0 Flash</h4>
                    <p>Legacy fast model</p>
                </div>
            </div>
            <button class="manage-api-button" id="manageApiButton">Manage API Key</button>
        </div>
    </div>

    <script>
        // Gemini AI Configuration
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        
        // Chat state
        let conversationHistory = [];
        let currentMode = 'normal';
        let currentModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
        let isGenerating = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const modeButton = document.getElementById('modeButton');
        const popupMenu = document.getElementById('popupMenu');
        const closePopup = document.getElementById('closePopup');
        const overlay = document.getElementById('overlay');
        const modeOptions = document.querySelectorAll('.mode-option');
        const modelSelectButton = document.getElementById('modelSelectButton');
        const modelPopupMenu = document.getElementById('modelPopupMenu');
        const closeModelPopup = document.getElementById('closeModelPopup');
        const modelOptions = document.querySelectorAll('.model-option');
        const apiSetup = document.getElementById('apiSetup');
        const manageApiButton = document.getElementById('manageApiButton');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const toggleApiVisibility = document.getElementById('toggleApiVisibility');
        const copyApiKey = document.getElementById('copyApiKey');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const removeApiKeyButton = document.getElementById('removeApiKeyButton');
        const apiSetupTitle = document.getElementById('apiSetupTitle');
        const apiSetupSubtitle = document.getElementById('apiSetupSubtitle');

        // Mode system prompts
        const modePrompts = {
            normal: "You are Umbraix AI, a helpful and friendly assistant. Provide clear, concise, and accurate responses. Be conversational and engaging.",
            
            webSearch: "You are Umbraix AI in Web Search mode. Act as if you have access to current web information and provide comprehensive, well-researched responses with specific details and examples. Be thorough and informative.",
            
            think: "You are Umbraix AI in Think Mode. Provide deep, analytical responses. Break down complex topics, show your reasoning process, consider multiple perspectives, and provide thoughtful insights. Structure your responses with clear logic and evidence.",
            
            creative: "You are Umbraix AI in Creative mode. Be imaginative, innovative, and think outside the box. Provide creative solutions, generate novel ideas, use analogies, and approach problems from unique angles. Be inspiring and original."
        };

        // Utility function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (!GEMINI_API_KEY) {
                showApiSetup();
            } else {
                hideApiSetup();
                addInitialMessage();
            }
            
            updateSelection('mode', currentMode);
            updateSelection('model', currentModel);
            updateChatHeader();
            setupEventListeners();
        });

        // API Key Management
        function showApiSetup() {
            apiSetup.style.display = 'flex';
        }

        function hideApiSetup() {
            apiSetup.style.display = 'none';
        }

        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                GEMINI_API_KEY = apiKey;
                localStorage.setItem('gemini_api_key', apiKey);
                hideApiSetup();
                if (conversationHistory.length === 0) {
                    addInitialMessage();
                }
            } else {
                alert('Please enter a valid API key');
            }
        }

        // Fixed formatAIResponse function to handle code properly
        function formatAIResponse(text) {
            // First, escape all HTML characters to prevent injection
            let escapedText = escapeHtml(text);
            
            // Handle code blocks first (triple backticks)
            escapedText = escapedText.replace(/``````/g, function(match, code) {
                return '<pre><code>' + code.trim() + '</code></pre>';
            });
            
            // Handle inline code (single backticks) - but not if it's inside a code block
            escapedText = escapedText.replace(/`([^`\n]+)`/g, '<code>$1</code>');
            
            // Handle bold text
            escapedText = escapedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Handle italic text
            escapedText = escapedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Handle line breaks and paragraphs
            escapedText = escapedText.replace(/\n\n/g, '</p><p>');
            escapedText = escapedText.replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags
            escapedText = '<p>' + escapedText + '</p>';
            
            // Clean up empty paragraphs
            escapedText = escapedText.replace(/<p><\/p>/g, '');
            escapedText = escapedText.replace(/<p>\s*<\/p>/g, '');
            
            return escapedText;
        }

        // Message Management
        function addMessage(text, isUser = false, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (isUser) {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('ai-message');
                if (isError) {
                    messageDiv.classList.add('error-message');
                }
                
                // Use the fixed formatting function
                const formattedText = formatAIResponse(text);
                messageDiv.innerHTML = formattedText;
                
                // Add mode indicator if not normal and not error
                if (currentMode !== 'normal' && !isError) {
                    const modeIndicator = document.createElement('span');
                    modeIndicator.classList.add('mode-indicator');
                    modeIndicator.textContent = getDisplayName('mode', currentMode);
                    messageDiv.appendChild(modeIndicator);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addInitialMessage() {
            addMessage("Hello! I'm Umbraix AI, powered by Google Gemini 2.5 Flash. How can I help you today?");
        }

        function getDisplayName(type, value) {
            const names = {
                mode: {
                    normal: 'Normal',
                    webSearch: 'Web Search',
                    think: 'Think Mode',
                    creative: 'Creative'
                },
                model: {
                    'gemini-2.5-pro': 'Gemini 2.5 Pro',
                    'gemini-2.5-flash': 'Gemini 2.5 Flash',
                    'gemini-2.0-flash': 'Gemini 2.0 Flash'
                }
            };
            return names[type][value] || value;
        }

        function updateChatHeader() {
            const headerInfo = document.querySelector('.chat-header-info');
            headerInfo.innerHTML = `
                <h2>Umbraix AI</h2>
                <p>Online • Powered by ${getDisplayName('model', currentModel)}</p>
            `;
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Typing Indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Gemini AI Integration
        async function callGeminiAPI(message) {
            const systemPrompt = modePrompts[currentMode];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${GEMINI_API_KEY}`;
            
            // Build conversation context
            let conversationContext = [
                {
                    role: "user",
                    parts: [{ text: systemPrompt }]
                }
            ];

            // Add conversation history (last 10 messages for context)
            const recentHistory = conversationHistory.slice(-10);
            conversationContext = conversationContext.concat(recentHistory);

            // Add current message
            conversationContext.push({
                role: "user",
                parts: [{ text: message }]
            });

            const requestBody = {
                contents: conversationContext,
                generationConfig: {
                    temperature: currentMode === 'creative' ? 0.9 : 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid response format from Gemini API');
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                throw error;
            }
        }

        // Message Sending
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isGenerating) return;

            // Disable input and show loading state
            isGenerating = true;
            sendButton.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage(message, true);
            userInput.value = '';

            // Add to conversation history
            conversationHistory.push({
                role: "user",
                parts: [{ text: message }]
            });

            // Show typing indicator
            showTypingIndicator();

            try {
                // Call Gemini API
                const response = await callGeminiAPI(message);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response
                addMessage(response);

                // Add to conversation history
                conversationHistory.push({
                    role: "model",
                    parts: [{ text: response }]
                });

            } catch (error) {
                hideTypingIndicator();
                
                let errorMessage = 'Sorry, I encountered an error while processing your request. ';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'Please check your API key and try again.';
                } else if (error.message.includes('quota')) {
                    errorMessage += 'API quota exceeded. Please try again later.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your connection and try again.';
                } else {
                    errorMessage += 'Please try again.';
                }

                addMessage(errorMessage, false, true);
            } finally {
                // Re-enable input
                isGenerating = false;
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // Mode and Model Management
        function updateSelection(type, value) {
            const options = type === 'mode' ? modeOptions : modelOptions;
            options.forEach(option => {
                const dataValue = option.getAttribute(`data-${type}`);
                option.classList.toggle('active', dataValue === value);
            });
        }

        function openPopup() {
            closeModelPopupMenu();
            popupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('mode', currentMode);
        }

        function closePopupMenu() {
            popupMenu.classList.remove('show');
            if (!modelPopupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        function openModelPopup() {
            closePopupMenu();
            modelPopupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('model', currentModel);
        }

        function closeModelPopupMenu() {
            modelPopupMenu.classList.remove('show');
            if (!popupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            modeButton.addEventListener('click', openPopup);
            closePopup.addEventListener('click', closePopupMenu);

            modelSelectButton.addEventListener('click', openModelPopup);
            closeModelPopup.addEventListener('click', closeModelPopupMenu);

            overlay.addEventListener('click', () => {
                closePopupMenu();
                closeModelPopupMenu();
            });
            
            modeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentMode = this.getAttribute('data-mode');
                    updateSelection('mode', currentMode);
                    closePopupMenu();
                });
            });

            modelOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentModel = this.getAttribute('data-model');
                    localStorage.setItem('gemini_model', currentModel);
                    updateSelection('model', currentModel);
                    updateChatHeader();
                    closeModelPopupMenu();
                });
            });

            manageApiButton.addEventListener('click', () => {
                closeModelPopupMenu();
                apiSetupTitle.textContent = 'Manage API Key';
                apiSetupSubtitle.style.display = 'none';
                apiKeyInput.value = GEMINI_API_KEY;
                showApiSetup();
            });

            toggleApiVisibility.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                toggleApiVisibility.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
            });

            copyApiKey.addEventListener('click', () => {
                navigator.clipboard.writeText(apiKeyInput.value).then(() => {
                    alert('API Key copied to clipboard!');
                });
            });

            removeApiKeyButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to remove your API key?')) {
                    localStorage.removeItem('gemini_api_key');
                    GEMINI_API_KEY = '';
                    apiKeyInput.value = '';
                    apiSetupTitle.textContent = 'Setup Gemini AI';
                    apiSetupSubtitle.style.display = 'block';
                }
            });

            saveApiKeyButton.addEventListener('click', saveApiKey);
            
            // Close popups when clicking outside
            document.addEventListener('click', function(e) {
                if (popupMenu.classList.contains('show') && 
                    !popupMenu.contains(e.target) && 
                    !modeButton.contains(e.target)) {
                    closePopupMenu();
                }
                if (modelPopupMenu.classList.contains('show') &&
                    !modelPopupMenu.contains(e.target) &&
                    !modelSelectButton.contains(e.target)) {
                    closeModelPopupMenu();
                }
            });
            
            // Focus input when page loads
            userInput.focus();

            // API key input event
            apiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveApiKey();
                }
            });
        }

        // Clear conversation (optional feature)
        function clearConversation() {
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h3>Welcome to Umbraix AI</h3>
                    <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
                </div>
            `;
            addInitialMessage();
        }

        // Make clearConversation available globally for debugging
        window.clearConversation = clearConversation;
        
    </script>
</body>
</html>
