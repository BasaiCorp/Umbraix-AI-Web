<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbraix AI - Minimalist Assistant</title>
    <link rel="icon" href="img/logo_round.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div id="splash-screen">
        <img src="img/logo_transparant.png" alt="Umbraix AI Loading">
    </div>

    <!-- API Key Setup Modal -->
    <div class="api-setup" id="apiSetup">
        <div class="api-setup-content">
            <div class="api-popup-header">
                <h3>API Key Management</h3>
                <button class="close-popup" id="closeApiSetup"><i class="fas fa-times"></i></button>
            </div>
            <div class="api-tabs">
                <button class="api-tab-button active" data-tab="gemini">Gemini</button>
                <button class="api-tab-button" data-tab="openrouter">OpenRouter</button>
            </div>
            <div id="gemini-settings" class="api-tab-content active">
                <h4>Google Gemini API</h4>
                <p>High-quality models from Google.</p>
                <div class="api-key-input-container">
                    <input type="password" id="geminiApiKeyInput" placeholder="Enter your Gemini API key">
                    <button class="toggle-api-visibility" data-input="geminiApiKeyInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-setup-actions">
                    <button id="saveGeminiApiKey">Save Key</button>
                    <button id="removeGeminiApiKey" class="remove-button">Remove Key</button>
                </div>
                <p class="api-link">Get a key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
            </div>
            <div id="openrouter-settings" class="api-tab-content">
                <h4>OpenRouter API</h4>
                <p>Access a wide variety of models.</p>
                <div class="api-key-input-container">
                    <input type="password" id="openRouterApiKeyInput" placeholder="Enter your OpenRouter API key">
                    <button class="toggle-api-visibility" data-input="openRouterApiKeyInput"><i class="fas fa-eye"></i></button>
                </div>
                <div class="api-setup-actions">
                    <button id="saveOpenRouterApiKey">Save Key</button>
                    <button id="removeOpenRouterApiKey" class="remove-button">Remove Key</button>
                </div>
                <p class="api-link">Get a key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a></p>
            </div>
            <p class="api-storage-notice"><small>Your API keys are stored locally and never shared.</small></p>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-left">
                <img src="img/logo_round.png" alt="Umbraix AI">
                <div class="chat-title">
                    <h2>Umbraix AI</h2>
                    <p>Powered by <span id="modelName">Gemini 2.5 Flash</span></p>
                </div>
            </div>
            <div class="chat-header-right">
                <button class="header-action-button" id="modelSelectButton">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h3>Welcome to Umbraix AI</h3>
                <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
            </div>
            <div class="thinking-indicator" id="thinkingIndicator">Thinking...</div>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div class="popup-menu" id="popupMenu">
            <div class="popup-header">
                <h3>Select Mode</h3>
                <button class="close-popup" id="closePopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="normal">
                    <i class="fas fa-comment"></i>
                    <div class="option-text">
                        <h4>Normal</h4>
                        <p>Standard conversation</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="webSearch">
                    <i class="fas fa-search"></i>
                    <div class="option-text">
                        <h4>Web Search</h4>
                        <p>Search and analyze information</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="think">
                    <i class="fas fa-lightbulb"></i>
                    <div class="option-text">
                        <h4>Think Mode</h4>
                        <p>Deep analytical thinking</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="creative">
                    <i class="fas fa-paint-brush"></i>
                    <div class="option-text">
                        <h4>Creative</h4>
                        <p>Brainstorming & ideas</p>
                    </div>
                </div>
                <div class="mode-option" data-mode="imagen">
                    <i class="fas fa-image"></i>
                    <div class="option-text">
                        <h4>Imagen</h4>
                        <p>Generate images from text</p>
                        <span class="paid-notice">Paid API key required</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="input-area">
                <button class="mode-button" id="modeButton">
                    <i class="fas fa-plus"></i>
                </button>
                <input type="text" class="chat-input" id="userInput" placeholder="Message Umbraix AI...">
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <div class="popup-menu" id="modelPopupMenu">
            <div class="popup-header">
                <h3>Select Model</h3>
                <button class="close-popup" id="closeModelPopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-bar-container">
                <i class="fas fa-search"></i>
                <input type="text" id="modelSearchInput" placeholder="Search models...">
            </div>
            <div class="popup-footer">
                <button class="manage-api-button" id="manageApiButton">Manage API Keys</button>
                <button class="refresh-models-button" id="refreshModelsButton">
                    <i class="fas fa-sync-alt"></i> Refresh Models
                </button>
            </div>
            <div class="model-options">
                <div class="model-option" data-model="gemini-2.5-pro">
                    <i class="fas fa-brain"></i>
                    <div class="option-text">
                        <h4>Gemini 2.5 Pro</h4>
                        <p>Most powerful model</p>
                    </div>
                </div>
                <div class="model-option active" data-model="gemini-2.5-flash">
                    <i class="fas fa-bolt"></i>
                    <div class="option-text">
                        <h4>Gemini 2.5 Flash</h4>
                        <p>Fast and efficient</p>
                    </div>
                </div>
                <div class="model-option" data-model="gemini-2.0-flash">
                    <i class="fas fa-rocket"></i>
                    <div class="option-text">
                        <h4>Gemini 2.0 Flash</h4>
                        <p>Legacy fast model</p>
                    </div>
                </div>
                <div class="model-option" data-model="gemini-2.5-flash-image-preview">
                    <i class="fas fa-image"></i>
                    <div class="option-text">
                        <h4>Gemini 2.5 Flash Image</h4>
                        <p>Conversational image generation</p>
                    </div>
                </div>
                <div class="model-option" data-model="imagen-4.0-generate-001">
                    <i class="fas fa-camera-retro"></i>
                    <div class="option-text">
                        <h4>Imagen 4.0</h4>
                        <p>Dedicated image generation</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="openrouter.js"></script>
    <script>
        // API Key Configuration
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let OPENROUTER_API_KEY = localStorage.getItem('openrouter_api_key') || '';
        
        // Chat state
        let conversationHistory = [];
        let currentMode = 'normal';
        let currentModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
        let isGenerating = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const modeButton = document.getElementById('modeButton');
        const popupMenu = document.getElementById('popupMenu');
        const closePopup = document.getElementById('closePopup');
        const overlay = document.getElementById('overlay');
        const modeOptions = document.querySelectorAll('.mode-option');
        const modelSelectButton = document.getElementById('modelSelectButton');
        const modelPopupMenu = document.getElementById('modelPopupMenu');
        const closeModelPopup = document.getElementById('closeModelPopup');
        const modelOptions = document.querySelectorAll('.model-option');
        const apiSetup = document.getElementById('apiSetup');
        const manageApiButton = document.getElementById('manageApiButton');
        const closeApiSetup = document.getElementById('closeApiSetup');
        const apiTabs = document.querySelectorAll('.api-tab-button');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const openRouterApiKeyInput = document.getElementById('openRouterApiKeyInput');
        const saveGeminiApiKey = document.getElementById('saveGeminiApiKey');
        const removeGeminiApiKey = document.getElementById('removeGeminiApiKey');
        const saveOpenRouterApiKey = document.getElementById('saveOpenRouterApiKey');
        const removeOpenRouterApiKey = document.getElementById('removeOpenRouterApiKey');
        const toggleApiVisibilityButtons = document.querySelectorAll('.toggle-api-visibility');
        const refreshModelsButton = document.getElementById('refreshModelsButton');

        let allModels = [];
        const modelSearchInput = document.getElementById('modelSearchInput');

        // Mode system prompts
        const modePrompts = {
            normal: "You are Umbraix AI, a helpful and friendly assistant. Provide clear, concise, and accurate responses. Be conversational and engaging.",
            
            webSearch: "You are Umbraix AI in Web Search mode. Act as if you have access to current web information and provide comprehensive, well-researched responses with specific details and examples. Be thorough and informative.",
            
            think: "You are Umbraix AI in Think Mode. Provide deep, analytical responses. Break down complex topics, show your reasoning process, consider multiple perspectives, and provide thoughtful insights. Structure your responses with clear logic and evidence.",
            
            creative: "You are Umbraix AI in Creative mode. Be imaginative, innovative, and think outside the box. Provide creative solutions, generate novel ideas, use analogies, and approach problems from unique angles. Be inspiring and original.",

            imagen: "You are Umbraix AI in Imagen mode. Generate an image based on the user's prompt. You should only respond with the image, no text."
        };

        function loadGeneratedImages() {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('generated_image_')) {
                    const imageData = JSON.parse(localStorage.getItem(key));
                    addMessage(imageData.imageUrl, false, false, imageData.prompt);
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (!GEMINI_API_KEY && !OPENROUTER_API_KEY) {
                showApiSetup();
            } else {
                hideApiSetup();
                addInitialMessage();
                loadGeneratedImages();
            }
            
            updateSelection('mode', currentMode);
            updateChatHeader();
            setupEventListeners();
            populateModels();
        });

        // API Key Management
        function showApiSetup() {
            geminiApiKeyInput.value = GEMINI_API_KEY;
            openRouterApiKeyInput.value = OPENROUTER_API_KEY;
            apiSetup.style.display = 'flex';
        }

        function hideApiSetup() {
            apiSetup.style.display = 'none';
        }

        function saveApiKey(keyType) {
            let key, input;
            if (keyType === 'gemini') {
                input = geminiApiKeyInput;
                key = input.value.trim();
                GEMINI_API_KEY = key;
                localStorage.setItem('gemini_api_key', key);
            } else {
                input = openRouterApiKeyInput;
                key = input.value.trim();
                OPENROUTER_API_KEY = key;
                localStorage.setItem('openrouter_api_key', key);
            }
            alert(`${keyType.charAt(0).toUpperCase() + keyType.slice(1)} API Key saved!`);
            hideApiSetup();
            if (conversationHistory.length === 0) {
                addInitialMessage();
            }
            populateModels(); // Refresh models after adding a key
        }

        function removeApiKey(keyType) {
            if (confirm(`Are you sure you want to remove your ${keyType} API key?`)) {
                if (keyType === 'gemini') {
                    localStorage.removeItem('gemini_api_key');
                    GEMINI_API_KEY = '';
                    geminiApiKeyInput.value = '';
                } else {
                    localStorage.removeItem('openrouter_api_key');
                    OPENROUTER_API_KEY = '';
                    openRouterApiKeyInput.value = '';
                }
                alert(`${keyType.charAt(0).toUpperCase() + keyType.slice(1)} API Key removed.`);
            }
        }

        // Configure marked.js to use highlight.js for syntax highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-', // for CSS classes
            gfm: true,
            breaks: true,
        });

        // Refactored formatAIResponse to use marked.js
        function formatAIResponse(text) {
            // The code block HTML is now generated by marked.js, so we need a new way to add the copy button.
            // We can do this by post-processing the HTML from marked.js
            let html = marked.parse(text);

            // Create a temporary div to parse the generated HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Add copy button to each pre element
            tempDiv.querySelectorAll('pre').forEach((pre) => {
                const code = pre.querySelector('code');
                const language = code.className.replace('hljs language-', '');
                const codeId = `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                code.id = codeId;

                const container = document.createElement('div');
                container.className = 'code-block-container';

                const header = document.createElement('div');
                header.className = 'code-block-header';

                const langName = document.createElement('span');
                langName.className = 'language-name';
                langName.innerText = language;

                const copyButton = document.createElement('button');
                copyButton.className = 'copy-code-button';
                copyButton.title = 'Copy code';
                copyButton.innerHTML = '<i class="far fa-clipboard"></i> <span>Copy</span>';
                copyButton.onclick = () => copyCode(copyButton, codeId);

                header.appendChild(langName);
                header.appendChild(copyButton);

                container.appendChild(header);

                // insert container before pre, and move pre inside it
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(pre);
            });

            return tempDiv.innerHTML;
        }

        function copyCode(button, codeId) {
            if (!navigator.clipboard) {
                console.error('Clipboard API not available');
                button.innerHTML = '<span>Not supported</span>';
                button.disabled = true;
                return;
            }
            const codeElement = document.getElementById(codeId);
            if (codeElement) {
                navigator.clipboard.writeText(codeElement.innerText).then(() => {
                    button.innerHTML = '<i class="fas fa-check"></i> <span>Copied</span>';
                    button.classList.add('copied');
                    button.disabled = true;
                    setTimeout(() => {
                        button.innerHTML = '<i class="far fa-clipboard"></i> <span>Copy</span>';
                        button.classList.remove('copied');
                        button.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy code: ', err);
                    button.innerHTML = '<span>Failed!</span>';
                });
            }
        }

        // Message Management
        function addMessage(text, isUser = false, isError = false, prompt = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (isUser) {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('ai-message');
                if (isError) {
                    messageDiv.classList.add('error-message');
                }

                if (prompt) {
                    const promptDiv = document.createElement('div');
                    promptDiv.classList.add('prompt-text');
                    promptDiv.textContent = prompt;
                    messageDiv.appendChild(promptDiv);
                }
                
                if (text.startsWith('data:image/')) {
                    const img = document.createElement('img');
                    img.src = text;
                    img.classList.add('generated-image');
                    messageDiv.appendChild(img);
                } else {
                    // Use the fixed formatting function
                    const formattedText = formatAIResponse(text);
                    messageDiv.innerHTML = formattedText;
                }
                
                // Add mode indicator if not normal and not error
                if (currentMode !== 'normal' && !isError) {
                    const modeIndicator = document.createElement('span');
                    modeIndicator.classList.add('mode-indicator');
                    modeIndicator.textContent = getDisplayName('mode', currentMode);
                    messageDiv.appendChild(modeIndicator);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addInitialMessage() {
            addMessage("Hello! I'm Umbraix AI, powered by Google Gemini 2.5 Flash. How can I help you today?");
        }

        function getDisplayName(type, value) {
            const names = {
                mode: {
                    normal: 'Normal',
                    webSearch: 'Web Search',
                    think: 'Think Mode',
                    creative: 'Creative',
                    imagen: 'Imagen'
                },
                model: {
                    'gemini-2.5-pro': 'Gemini 2.5 Pro',
                    'gemini-2.5-flash': 'Gemini 2.5 Flash',
                    'gemini-2.0-flash': 'Gemini 2.0 Flash',
                    'gemini-2.5-flash-image-preview': 'Gemini 2.5 Flash Image',
                    'imagen-4.0-generate-001': 'Imagen 4.0'
                }
            };
            return names[type][value] || value;
        }

        function updateChatHeader() {
            const modelNameSpan = document.getElementById('modelName');
            if (modelNameSpan) {
                modelNameSpan.textContent = getDisplayName('model', currentModel);
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Typing Indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typingIndicatorOld';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicatorOld');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function showThinkingIndicator() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.style.display = 'block';
            scrollToBottom();
        }

        function hideThinkingIndicator() {
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            thinkingIndicator.style.display = 'none';
        }

        // Gemini AI Integration
        async function populateModels() {
            const modelOptionsContainer = modelPopupMenu.querySelector('.model-options');
            modelOptionsContainer.innerHTML = ''; // Clear existing models

            const staticGeminiModels = [
                { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', description: 'Most powerful model', provider: 'gemini' },
                { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', description: 'Fast and efficient', provider: 'gemini' },
                { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', description: 'Legacy fast model', provider: 'gemini' },
                { id: 'gemini-2.5-flash-image-preview', name: 'Gemini 2.5 Flash Image', description: 'Conversational image generation', provider: 'gemini' },
                { id: 'imagen-4.0-generate-001', name: 'Imagen 4.0', description: 'Dedicated image generation', provider: 'gemini' }
            ];

            allModels = staticGeminiModels.map(m => ({...m, provider: 'gemini'}));

            if (OPENROUTER_API_KEY) {
                try {
                    const openRouterModels = await fetchOpenRouterModels(OPENROUTER_API_KEY);
                    const mappedModels = openRouterModels.map(model => ({
                        id: model.id,
                        name: model.name,
                        description: `Provider: ${model.context_length}`,
                        provider: 'openrouter'
                    }));
                    allModels = allModels.concat(mappedModels);
                } catch (error) {
                    console.error("Failed to fetch OpenRouter models:", error);
                }
            }

            displayModels(allModels);

            // Set default or saved model
            currentModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
            updateSelection('model', currentModel);
            updateChatHeader();
        }

        function displayModels(modelsToDisplay) {
            const modelOptionsContainer = modelPopupMenu.querySelector('.model-options');
            modelOptionsContainer.innerHTML = '';

            modelsToDisplay.forEach(model => {
                const option = document.createElement('div');
                option.className = 'model-option';
                option.setAttribute('data-model', model.id);
                option.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <div class="option-text">
                        <h4>${escapeHtml(model.name)}</h4>
                        <p>${escapeHtml(model.description)}</p>
                    </div>
                `;
                modelOptionsContainer.appendChild(option);

                option.addEventListener('click', function() {
                    currentModel = this.getAttribute('data-model');
                    localStorage.setItem('gemini_model', currentModel);
                    updateSelection('model', currentModel);
                    updateChatHeader();
                    closeModelPopupMenu();
                });
            });
        }

        async function callApi(message) {
            const modelData = allModels.find(m => m.id === currentModel);
            if (!modelData) {
                throw new Error("Selected model not found!");
            }

            if (modelData.provider === 'openrouter') {
                if (!OPENROUTER_API_KEY) throw new Error("OpenRouter API key not set.");
                const history = conversationHistory.map(item => ({
                    role: item.role === 'model' ? 'assistant' : 'user',
                    content: item.parts[0].text
                }));
                return await callOpenRouterAPI(OPENROUTER_API_KEY, currentModel, history);
            } else {
                // Default to Gemini
                if (!GEMINI_API_KEY) throw new Error("Gemini API key not set.");
                return await callGeminiAPI(message);
            }
        }

        async function callGeminiAPI(message) {
            const systemPrompt = modePrompts[currentMode];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${GEMINI_API_KEY}`;

            let conversationContext = [{ role: "user", parts: [{ text: systemPrompt }] }];
            conversationContext = conversationContext.concat(conversationHistory.slice(-10));
            conversationContext.push({ role: "user", parts: [{ text: message }] });

            const requestBody = {
                contents: conversationContext,
                generationConfig: {
                    temperature: currentMode === 'creative' ? 0.9 : 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error('Invalid response format from Gemini API');
        }

        async function callImagen4API(message) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${GEMINI_API_KEY}`;

            const requestBody = {
                "instances": [
                    {
                        "prompt": message
                    }
                ],
                "parameters": {
                    "sampleCount": 1
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.predictions && data.predictions[0] && data.predictions[0].image) {
                    const imageUrl = `data:image/png;base64,${data.predictions[0].image.bytesBase64Encoded}`;
                    const imageId = `generated_image_${Date.now()}`;
                    const imageData = {
                        prompt: message,
                        imageUrl: imageUrl
                    };
                    localStorage.setItem(imageId, JSON.stringify(imageData));
                    return imageUrl;
                }

                throw new Error('No image data found in response');

            } catch (error) {
                console.error('Imagen 4 API Error:', error);
                throw error;
            }
        }

        async function callGeminiFlashImageAPI(message) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;

            const requestBody = {
                contents: [{
                    parts: [
                        { "text": message }
                    ]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const imagePart = data.candidates[0].content.parts.find(part => part.inline_data);
                    if (imagePart) {
                        const imageUrl = `data:image/png;base64,${imagePart.inline_data.data}`;
                        const imageId = `generated_image_${Date.now()}`;
                        const imageData = {
                            prompt: message,
                            imageUrl: imageUrl
                        };
                        localStorage.setItem(imageId, JSON.stringify(imageData));
                        return imageUrl;
                    }
                }

                throw new Error('No image data found in response');

            } catch (error) {
                console.error('Imagen API Error:', error);
                throw error;
            }
        }

        // Message Sending
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isGenerating) return;

            // Disable input and show loading state
            isGenerating = true;
            sendButton.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage(message, true);
            userInput.value = '';
            sendButton.classList.remove('active');

            // Add to conversation history
            conversationHistory.push({
                role: "user",
                parts: [{ text: message }]
            });

            // Show typing indicator
            if (currentModel === 'gemini-2.5-pro' && currentMode === 'think') {
                showThinkingIndicator();
            } else {
                showTypingIndicator();
            }

            try {
                let response;
                if (currentMode === 'imagen') {
                    if (currentModel === 'gemini-2.5-flash-image-preview') {
                        response = await callGeminiFlashImageAPI(message);
                    } else if (currentModel === 'imagen-4.0-generate-001') {
                        response = await callImagen4API(message);
                    } else {
                        // Default to flash image API if no specific image model is selected
                        response = await callGeminiFlashImageAPI(message);
                    }
                } else {
                    response = await callApi(message);
                }
                
                // Hide typing indicator
                if (currentModel === 'gemini-2.5-pro' && currentMode === 'think') {
                    hideThinkingIndicator();
                } else {
                    hideTypingIndicator();
                }
                
                // Add AI response
                if (currentMode === 'imagen') {
                    addMessage(response, false, false, message);
                } else {
                    addMessage(response);
                }

                // Add to conversation history
                conversationHistory.push({
                    role: "model",
                    parts: [{ text: response }]
                });

            } catch (error) {
                hideTypingIndicator();
                
                let errorMessage = 'Sorry, I encountered an error while processing your request. ';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'Please check your API key and try again.';
                } else if (error.message.includes('quota')) {
                    errorMessage += 'API quota exceeded. Please try again later.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your connection and try again.';
                } else {
                    errorMessage += 'Please try again.';
                }

                addMessage(errorMessage, false, true);
            } finally {
                // Re-enable input
                isGenerating = false;
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // Mode and Model Management
        function updateSelection(type, value) {
            const options = type === 'mode' ? modeOptions : modelOptions;
            options.forEach(option => {
                const dataValue = option.getAttribute(`data-${type}`);
                option.classList.toggle('active', dataValue === value);
            });
        }

        function openPopup() {
            closeModelPopupMenu();
            popupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('mode', currentMode);
        }

        function closePopupMenu() {
            popupMenu.classList.remove('show');
            if (!modelPopupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        function openModelPopup() {
            closePopupMenu();
            modelPopupMenu.classList.add('show');
            overlay.classList.add('show');
            updateSelection('model', currentModel);
        }

        function closeModelPopupMenu() {
            modelPopupMenu.classList.remove('show');
            if (!popupMenu.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            modeButton.addEventListener('click', openPopup);
            closePopup.addEventListener('click', closePopupMenu);

            modelSelectButton.addEventListener('click', openModelPopup);
            closeModelPopup.addEventListener('click', closeModelPopupMenu);

            overlay.addEventListener('click', () => {
                closePopupMenu();
                closeModelPopupMenu();
            });
            
            modeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentMode = this.getAttribute('data-mode');
                    updateSelection('mode', currentMode);
                    closePopupMenu();
                });
            });

            modelOptions.forEach(option => {
                option.addEventListener('click', function() {
                    currentModel = this.getAttribute('data-model');
                    localStorage.setItem('gemini_model', currentModel);
                    updateSelection('model', currentModel);
                    updateChatHeader();
                    closeModelPopupMenu();
                });
            });

            manageApiButton.addEventListener('click', () => {
                closeModelPopupMenu();
                showApiSetup();
            });

            closeApiSetup.addEventListener('click', hideApiSetup);

            apiTabs.forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    document.querySelectorAll('.api-tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tab}-settings`).classList.add('active');
                    document.querySelectorAll('.api-tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });

            toggleApiVisibilityButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.dataset.input;
                    const input = document.getElementById(inputId);
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    button.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
                });
            });

            saveGeminiApiKey.addEventListener('click', () => saveApiKey('gemini'));
            removeGeminiApiKey.addEventListener('click', () => removeApiKey('gemini'));
            saveOpenRouterApiKey.addEventListener('click', () => saveApiKey('openrouter'));
            removeOpenRouterApiKey.addEventListener('click', () => removeApiKey('openrouter'));
            refreshModelsButton.addEventListener('click', populateModels);

            modelSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredModels = allModels.filter(model => model.name.toLowerCase().includes(searchTerm));
                displayModels(filteredModels);
            });

            // Close popups when clicking outside
            document.addEventListener('click', function(e) {
                if (popupMenu.classList.contains('show') && 
                    !popupMenu.contains(e.target) && 
                    !modeButton.contains(e.target)) {
                    closePopupMenu();
                }
                if (modelPopupMenu.classList.contains('show') &&
                    !modelPopupMenu.contains(e.target) &&
                    !modelSelectButton.contains(e.target)) {
                    closeModelPopupMenu();
                }
            });
            
            // Focus input when page loads
            userInput.focus();

            // API key input events
            geminiApiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveApiKey('gemini');
                }
            });
            openRouterApiKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveApiKey('openrouter');
                }
            });

            // Send button active state
            userInput.addEventListener('input', () => {
                if (userInput.value.trim() !== '') {
                    sendButton.classList.add('active');
                } else {
                    sendButton.classList.remove('active');
                }
            });
        }

        // Clear conversation (optional feature)
        function clearConversation() {
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <h3>Welcome to Umbraix AI</h3>
                    <p>Ask me anything - I'm here to help with your questions, ideas, and tasks. Use the + button for special modes.</p>
                </div>
            `;
            addInitialMessage();
        }

        // Make clearConversation available globally for debugging
        window.clearConversation = clearConversation;

        // Splash screen logic
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');

            // Start the fade out
            setTimeout(() => {
                splash.classList.add('hidden');
            }, 2000);

            // Remove from DOM after transition
            splash.addEventListener('transitionend', (e) => {
                if (e.propertyName === 'opacity') {
                    splash.style.display = 'none';
                }
            });
        });
        
    </script>
</body>
</html>
